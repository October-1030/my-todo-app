<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能待办清单</title>
    <meta name="theme-color" content="#667eea">

```
<!-- PWA支持 -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5pm66IO95b6F5Yqe5riF5YiVIiwic2hvcnRfbmFtZSI6IuW+heWKnuS7iSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjNjY3ZWVhIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEQ5NGJXd2dkbVZ5YzJsdmJqMGlNUzR3SWlCbGJtTnZaR2x1WnowaVZWUkdMVGdpUHo0OEMzWm5JR2hsYVdkb2REMGlNalEwSWlCM2FXUjBhRDBpTWpRMElpQm1hV3hzUFNJak5qWjNaV1ZoSWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4d1lYUm9JR1E5SWsweE1pQXpJRXc0SURNZ1REZ2dNVFVnVERFeUlESTNJRXc0SURJM0lFeElERXlJREk1SW5BK1BIQmhkR2dnWkQwaVRUWWdOaUJNTVRnZ05pQk1NVGNNRFV3S1pHRXRNVFE0VERRdE5VZFlNVFl0TVRWR01ERXROa3cyTVM0MUxURXVOVGgyTURrek5TTXRNVEV1TkRZdE5EZ3VOaTQyTnkwNU55NHpNelE0TFRJdU9USWdNVEZqTFRJMkxqZzJJRGN1TkRNdE1qZzJNUzR3T0N3NElqRXhMVGcxTFRNeElETWpMVGMyTGpJZ01UUXVNVGdnTVRRdU1UZ3ROekkxSWk4K1BIQmhkR2dnWkQwaVRUazVJRGtnVERrNUlEa3VNamsxSUV3NE5TNDNJRUUyTGpJMUlEWXVNalVnTUNCd01ERTRJREFnTVRrZ01URWdNVGtnTVRrZ01URWdhREkzSWlBdkBnb3FQSFB4SXpVRFl3SlJGY1E4NThyOFVnPSIsInNpemVzIjoiMjQyeDI0MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .header {
        text-align: center;
        margin-bottom: 25px;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }

    .header h1 {
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
    }

    .date-time {
        color: #666;
        font-size: 14px;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 15px;
        border-radius: 15px;
        text-align: center;
        color: white;
        box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px) scale(1.02);
    }

    .stat-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .stat-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    }

    .stat-number {
        font-size: 24px;
        font-weight: 700;
        display: block;
    }

    .stat-label {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 2px;
    }

    .input-section {
        margin-bottom: 25px;
    }

    .input-group {
        background: #f8f9fc;
        border-radius: 15px;
        padding: 4px;
        margin-bottom: 15px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    input[type="text"] {
        flex: 1;
        padding: 15px 18px;
        border: none;
        border-radius: 12px;
        background: white;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    input[type="text"]:focus {
        outline: none;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
    }

    input[type="date"], select {
        padding: 12px 15px;
        border: none;
        border-radius: 12px;
        background: white;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-width: 100px;
    }

    .add-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        width: 100%;
    }

    .add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
    }

    .add-btn:active {
        transform: translateY(0);
    }

    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
        justify-content: center;
    }

    .filter-btn {
        padding: 8px 12px;
        border: 2px solid #e1e5f2;
        border-radius: 15px;
        background: white;
        color: #667eea;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 0 0 auto;
        min-width: fit-content;
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .task-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .task-category {
        margin-bottom: 20px;
    }

    .category-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 14px;
        color: #333;
    }

    .category-count {
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 8px;
    }

    .task-item {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border-left: 4px solid;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .task-item.overdue { border-left-color: #ff6b6b; }
    .task-item.today { border-left-color: #feca57; }
    .task-item.reminder { border-left-color: #ff9ff3; }
    .task-item.upcoming { border-left-color: #48dbfb; }
    .task-item.completed { 
        border-left-color: #1dd1a1; 
        opacity: 0.7;
    }

    .task-checkbox {
        width: 24px;
        height: 24px;
        border: 3px solid #ddd;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
    }

    .task-checkbox:hover {
        border-color: #667eea;
        transform: scale(1.1);
    }

    .task-checkbox.completed {
        background: #1dd1a1;
        border-color: #1dd1a1;
        color: white;
    }

    .task-content {
        flex: 1;
    }

    .task-text {
        font-size: 15px;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
    }

    .task-text.completed {
        text-decoration: line-through;
        color: #999;
    }

    .task-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .task-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 18px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .action-btn.delete {
        background: #ffebee;
        color: #f44336;
    }

    .action-btn.delete:hover {
        background: #f44336;
        color: white;
        transform: scale(1.1);
    }

    .action-btn.undo {
        background: #fff3e0;
        color: #ff9800;
    }

    .action-btn.undo:hover {
        background: #ff9800;
        color: white;
        transform: scale(1.1);
    }

    .backup-section {
        background: #f8f9fc;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
    }

    .backup-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
    }

    .backup-buttons {
        display: flex;
        gap: 10px;
    }

    .backup-btn {
        flex: 1;
        padding: 12px;
        border: 2px solid #667eea;
        border-radius: 12px;
        background: white;
        color: #667eea;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .backup-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-1px);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state .emoji {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
    }

    .sync-status {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ff6b6b;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .sync-status.online { background: #1dd1a1; }
    .sync-status.syncing { 
        background: #feca57;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* 响应式设计 */
    @media (max-width: 480px) {
        body { padding: 10px; }
        .container { padding: 20px; }
        .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .input-row { flex-direction: column; }
        input[type="date"], select { min-width: auto; }
    }

    /* 滚动条样式 */
    .task-list::-webkit-scrollbar {
        width: 6px;
    }

    .task-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .task-list::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 3px;
    }
</style>
```

</head>
<body>
    <div class="sync-status" id="syncStatus" title="同步状态"></div>

```
<div class="container">
    <div class="header">
        <h1>📋 智能待办清单</h1>
        <div class="date-time" id="dateTime"></div>
    </div>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <span class="stat-number" id="totalTasks">0</span>
            <span class="stat-label">总任务</span>
        </div>
        <div class="stat-card primary">
            <span class="stat-number" id="todayTasks">0</span>
            <span class="stat-label">今日待办</span>
        </div>
        <div class="stat-card success">
            <span class="stat-number" id="completedTasks">0</span>
            <span class="stat-label">已完成</span>
        </div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <div class="input-row">
                <input type="text" id="taskInput" placeholder="添加新任务..." maxlength="100">
            </div>
            <div class="input-row">
                <input type="date" id="taskDate">
                <select id="reminderDays">
                    <option value="0">无提醒</option>
                    <option value="1">提前1天</option>
                    <option value="3">提前3天</option>
                    <option value="7">提前7天</option>
                    <option value="14">提前14天</option>
                </select>
                <select id="repeatType">
                    <option value="none">不重复</option>
                    <option value="daily">每天</option>
                    <option value="weekly">每周</option>
                    <option value="monthly">每月</option>
                </select>
            </div>
            <button class="add-btn" onclick="addTask()">🚀 添加任务</button>
        </div>
    </div>

    <div class="filters" id="filters">
        <button class="filter-btn active" data-filter="all">📋 全部</button>
        <button class="filter-btn" data-filter="ongoing">🚀 进行中</button>
        <button class="filter-btn" data-filter="overdue">🔥 逾期</button>
        <button class="filter-btn" data-filter="today">⏰ 今日</button>
        <button class="filter-btn" data-filter="reminder">🔔 提醒</button>
        <button class="filter-btn" data-filter="upcoming">📅 未来</button>
        <button class="filter-btn" data-filter="completed">✅ 已完成</button>
    </div>

    <div class="task-list" id="taskList">
        <div class="empty-state">
            <span class="emoji">✨</span>
            <div>暂无任务</div>
            <small>添加第一个任务开始高效生活！</small>
        </div>
    </div>

    <div class="backup-section">
        <div class="backup-title">📤 数据管理</div>
        <div class="backup-buttons">
            <button class="backup-btn" onclick="exportData()">📤 导出备份</button>
            <button class="backup-btn" onclick="importData()">📥 导入备份</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
    </div>
</div>

<script type="module">
    // Firebase配置 - 使用你的配置
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCQMq8-YMCd2_VerYKw2PCcqdXmjpcvfF8",
        authDomain: "my-todo-sync.firebaseapp.com",
        databaseURL: "https://my-todo-sync-default-rtdb.firebaseio.com",
        projectId: "my-todo-sync",
        storageBucket: "my-todo-sync.firebasestorage.app",
        messagingSenderId: "807738313038",
        appId: "1:807738313038:web:6c583cc14e898eed87b61f"
    };

    let app, database;
    let tasks = [];
    let currentFilter = 'all';
    let isOnline = false;

    // 初始化Firebase
    try {
        app = initializeApp(firebaseConfig);
        database = getDatabase(app);
        setupFirebaseSync();
    } catch (error) {
        console.error('Firebase初始化失败:', error);
        updateSyncStatus('offline');
        loadLocalTasks();
    }

    // Firebase同步设置
    function setupFirebaseSync() {
        const tasksRef = ref(database, 'tasks');
        
        onValue(tasksRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                tasks = Object.values(data).map(task => ({
                    ...task,
                    dueDate: task.dueDate || null,
                    reminderDays: task.reminderDays || 0,
                    repeatType: task.repeatType || 'none'
                }));
                updateSyncStatus('online');
                saveLocalTasks(); // 本地备份
                renderTasks();
            }
        }, (error) => {
            console.error('Firebase同步失败:', error);
            updateSyncStatus('offline');
            loadLocalTasks();
        });
    }

    // 同步状态更新
    function updateSyncStatus(status) {
        const syncStatus = document.getElementById('syncStatus');
        syncStatus.className = `sync-status ${status}`;
        
        const statusText = {
            'online': '在线同步',
            'offline': '离线模式', 
            'syncing': '同步中...'
        };
        
        syncStatus.title = statusText[status] || '未知状态';
        isOnline = status === 'online';
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', function() {
        updateDateTime();
        setInterval(updateDateTime, 60000);
        
        // 事件监听器
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });

        // 过滤器事件
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderTasks();
            });
        });

        // PWA支持
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,');
        }
    });

    function updateDateTime() {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long',
            hour: '2-digit',
            minute: '2-digit'
        };
        document.getElementById('dateTime').textContent = now.toLocaleDateString('zh-CN', options);
    }

    function addTask() {
        const input = document.getElementById('taskInput');
        const dateInput = document.getElementById('taskDate');
        const reminderSelect = document.getElementById('reminderDays');
        const repeatSelect = document.getElementById('repeatType');
        
        const text = input.value.trim();
        if (!text) return;

        const task = {
            id: Date.now(),
            text: text,
            completed: false,
            createdAt: new Date().toISOString(),
            dueDate: dateInput.value || null,
            reminderDays: parseInt(reminderSelect.value) || 0,
            repeatType: repeatSelect.value || 'none'
        };

        tasks.unshift(task);
        saveTasks();
        renderTasks();
        
        // 清空输入
        input.value = '';
        dateInput.value = '';
        reminderSelect.value = '0';
        repeatSelect.value = 'none';
    }

    function toggleTask(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;

        // 处理重复任务
        if (task.completed && task.repeatType !== 'none') {
            createRecurringTask(task);
        }

        saveTasks();
        renderTasks();
    }

    function createRecurringTask(originalTask) {
        if (!originalTask.dueDate) return;

        const nextDate = new Date(originalTask.dueDate);
        switch (originalTask.repeatType) {
            case 'daily':
                nextDate.setDate(nextDate.getDate() + 1);
                break;
            case 'weekly':
                nextDate.setDate(nextDate.getDate() + 7);
                break;
            case 'monthly':
                nextDate.setMonth(nextDate.getMonth() + 1);
                break;
            default:
                return;
        }

        const newTask = {
            ...originalTask,
            id: Date.now(),
            completed: false,
            createdAt: new Date().toISOString(),
            completedAt: null,
            dueDate: nextDate.toISOString().split('T')[0]
        };

        tasks.unshift(newTask);
    }

    function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        saveTasks();
        renderTasks();
    }

    function categorizeTask(task) {
        if (task.completed) return 'completed';
        
        if (!task.dueDate) return 'upcoming';
        
        const today = new Date();
        const taskDate = new Date(task.dueDate);
        const daysDiff = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 0) return 'overdue';
        if (daysDiff === 0) return 'today';
        if (task.reminderDays > 0 && daysDiff <= task.reminderDays) return 'reminder';
        return 'upcoming';
    }

    function renderTasks() {
        const taskList = document.getElementById('taskList');
        let filteredTasks = tasks;

        // 应用过滤器
        if (currentFilter === 'ongoing') {
            // 进行中 = 所有未完成的任务（逾期+今日+提醒+未来）
            filteredTasks = tasks.filter(task => !task.completed);
        } else if (currentFilter !== 'all') {
            filteredTasks = tasks.filter(task => categorizeTask(task) === currentFilter);
        }

        if (filteredTasks.length === 0) {
            const emptyMessages = {
                'all': '暂无任务',
                'ongoing': '暂无进行中的任务', 
                'overdue': '太棒了！没有逾期任务',
                'today': '今日无任务安排',
                'reminder': '暂无提醒任务',
                'upcoming': '暂无未来任务',
                'completed': '还没有完成的任务'
            };
            
            taskList.innerHTML = `
                <div class="empty-state">
                    <span class="emoji">✨</span>
                    <div>${emptyMessages[currentFilter] || '该分类暂无任务'}</div>
                    <small>${currentFilter === 'all' ? '添加第一个任务开始高效生活！' : '切换到其他分类查看'}</small>
                </div>
            `;
            updateStats();
            return;
        }

        // 按类别分组
        const categories = {
            overdue: { title: '🔥 逾期任务', tasks: [] },
            today: { title: '⏰ 今日任务', tasks: [] },
            reminder: { title: '🔔 提醒任务', tasks: [] },
            upcoming: { title: '📅 未来任务', tasks: [] },
            completed: { title: '✅ 已完成', tasks: [] }
        };

        filteredTasks.forEach(task => {
            const category = categorizeTask(task);
            categories[category].tasks.push(task);
        });

        let html = '';
        Object.entries(categories).forEach(([key, category]) => {
            if (category.tasks.length > 0 && (currentFilter === 'all' || currentFilter === key || (currentFilter === 'ongoing' && key !== 'completed'))) {
                html += `
                    <div class="task-category">
                        <div class="category-header">
                            ${category.title}
                            <span class="category-count">${category.tasks.length}</span>
                        </div>
                        ${category.tasks.map(task => renderTask(task, key)).join('')}
                    </div>
                `;
            }
        });

        taskList.innerHTML = html;
        updateStats();
    }

    function renderTask(task, category) {
        const dueText = task.dueDate ? 
            `📅 ${new Date(task.dueDate).toLocaleDateString('zh-CN')}` : 
            '📅 无截止日期';
        
        const repeatText = task.repeatType !== 'none' ? 
            `🔄 ${{'daily': '每天', 'weekly': '每周', 'monthly': '每月'}[task.repeatType]}` : '';
        
        const reminderText = task.reminderDays > 0 ? 
            `🔔 提前${task.reminderDays}天提醒` : '';
        
        return `
            <div class="task-item ${category}">
                <div class="task-checkbox ${task.completed ? 'completed' : ''}" 
                     onclick="toggleTask(${task.id})">
                    ${task.completed ? '✓' : ''}
                </div>
                <div class="task-content">
                    <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                    <div class="task-meta">
                        <span>${dueText}</span>
                        ${repeatText ? `<span>${repeatText}</span>` : ''}
                        ${reminderText ? `<span>${reminderText}</span>` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    ${task.completed ? 
                        `<button class="action-btn undo" onclick="toggleTask(${task.id})" title="撤销完成">↩️</button>` :
                        ''
                    }
                    <button class="action-btn delete" onclick="deleteTask(${task.id})" title="删除任务">🗑️</button>
                </div>
            </div>
        `;
    }

    function updateStats() {
        const total = tasks.length;
        const completed = tasks.filter(t => t.completed).length;
        const ongoing = tasks.filter(t => !t.completed).length;
        const today = tasks.filter(t => {
            const cat = categorizeTask(t);
            return cat === 'today' || cat === 'overdue';
        }).length;
        
        document.getElementById('totalTasks').textContent = total;
        document.getElementById('completedTasks').textContent = completed;
        document.getElementById('todayTasks').textContent = today;
    }

    function saveTasks() {
        if (isOnline && database) {
            updateSyncStatus('syncing');
            try {
                const tasksRef = ref(database, 'tasks');
                const tasksObj = {};
                tasks.forEach(task => {
                    tasksObj[task.id] = task;
                });
                set(tasksRef, tasksObj).then(() => {
                    updateSyncStatus('online');
                }).catch(error => {
                    console.error('云端保存失败:', error);
                    updateSyncStatus('offline');
                    saveLocalTasks();
                });
            } catch (error) {
                console.error('同步失败:', error);
                updateSyncStatus('offline');
                saveLocalTasks();
            }
        } else {
            saveLocalTasks();
        }
    }

    function saveLocalTasks() {
        try {
            localStorage.setItem('mobileTasks', JSON.stringify(tasks));
            localStorage.setItem('tasksBackup', JSON.stringify({
                tasks: tasks,
                timestamp: new Date().toISOString(),
                version: '2.0'
            }));
        } catch (error) {
            console.error('本地保存失败:', error);
        }
    }

    function loadLocalTasks() {
        try {
            const saved = localStorage.getItem('mobileTasks');
            if (saved) {
                tasks = JSON.parse(saved).map(task => ({
                    ...task,
                    dueDate: task.dueDate || null,
                    reminderDays: task.reminderDays || 0,
                    repeatType: task.repeatType || 'none'
                }));
                renderTasks();
            }
        } catch (error) {
            console.error('加载本地数据失败:', error);
            tasks = [];
            renderTasks();
        }
    }

    function exportData() {
        const data = {
            tasks: tasks,
            exportDate: new Date().toISOString(),
            version: '2.0',
            source: 'mobile'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `智能待办清单_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData() {
        document.getElementById('importFile').click();
    }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.tasks && Array.isArray(data.tasks)) {
                    // 数据兼容性处理
                    const importedTasks = data.tasks.map(task => ({
                        ...task,
                        dueDate: task.dueDate || null,
                        reminderDays: task.reminderDays || 0,
                        repeatType: task.repeatType || 'none'
                    }));
                    
                    if (confirm('是否合并数据？点击"确定"合并，点击"取消"替换所有数据。')) {
                        // 合并数据：避免重复ID
                        const existingIds = new Set(tasks.map(t => t.id));
                        const newTasks = importedTasks.filter(t => !existingIds.has(t.id));
                        tasks = [...tasks, ...newTasks];
                    } else {
                        // 替换数据
                        tasks = importedTasks;
                    }
                    
                    saveTasks();
                    renderTasks();
                    alert(`数据导入成功！导入了 ${importedTasks.length} 个任务。`);
                } else {
                    alert('文件格式不正确，请选择有效的备份文件。');
                }
            } catch (error) {
                console.error('导入失败:', error);
                alert('导入失败：' + error.message);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // 清空input
    }

    // 暴露全局函数
    window.addTask = addTask;
    window.toggleTask = toggleTask;
    window.deleteTask = deleteTask;
    window.exportData = exportData;
    window.importData = importData;
    window.handleImport = handleImport;
</script>
```

</body>
</html>
